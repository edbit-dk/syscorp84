
let path_public='public/';let stylesheets=path_public+'css/';let commandHistory=[];let historyIndex=-1;let currentDirectory='';let isPasswordPrompt=false;let userPassword='';let usernameForLogon='';let usernameForNewUser='';let isUsernamePrompt=false;let currentCommand='';let commands=[];let files=[];let folders=[];let cmd='';let currentSongIndex=0;let audio;$(document).ready(function(){loadSavedTheme();loadSavedTermMode();autoHelp();if(!localStorage.getItem('boot')){setTimeout(function(){sendCommand('boot','')},500);setTimeout(function(){localStorage.setItem('boot',true);clearTerminal();sendCommand('main','')},20000)}else{setTimeout(function(){sendCommand('main','');$('#connection').load('connection')},500)}});$('#command-input').keydown(function(e){if(e.key==='Enter'){e.preventDefault();if(isPasswordPrompt){handlePasswordPrompt()}else{handleUserInput()}}else if(e.key==='ArrowUp'){if(historyIndex>0){historyIndex--;$('#command-input').val(commandHistory[historyIndex])}}else if(e.key==='ArrowDown'){if(historyIndex<commandHistory.length-1){historyIndex++;$('#command-input').val(commandHistory[historyIndex])}else{historyIndex=commandHistory.length;$('#command-input').val('')}}else if(e.key==='Tab'){e.preventDefault();autocomplete()}});document.getElementById('play-button').addEventListener('click',toggleMusic);function handleResponse(response,timeout=1000){const cleanResponse=response.trim();if(cleanResponse.startsWith('TRYING')){setTimeout(function(){redirectTo('',true)},timeout)}if(cleanResponse.includes('SUCCESS: LOGGING OUT')){setTimeout(function(){redirectTo('',true)},timeout)}if(cleanResponse.includes('SUCCESS: SECURITY ACCESS CODE SEQUENCE ACCEPTED')){setTimeout(function(){redirectTo('',true)},timeout)}if(cleanResponse.includes('SUCCESS: LOGON ACCEPTED')){sessionStorage.setItem('host',true);setTimeout(function(){redirectTo('',true)},timeout)}}function redirectTo(url,reload=false){if(reload){return window.location.href=url}sendCommand('main','')}function isUplinkCode(input){const pattern=/^[A-Za-z0-9\-]{27}$/;return pattern.test(input)}function findCommonPrefix(strings){if(!strings.length)return'';let prefix=strings[0];for(let i=1;i<strings.length;i++){while(!strings[i].startsWith(prefix)){prefix=prefix.slice(0,-1);if(!prefix)break}}return prefix}function handleUserInput(){let input=$('#command-input').val().trim();if(input===''&&!(isPasswordPrompt||isUsernamePrompt))return;loadText($('#connection').text()+' '+input);commandHistory.push(input);localStorage.setItem('history',commandHistory);historyIndex=commandHistory.length;localStorage.setItem('index',historyIndex);$('#command-input').val('');if(input==='?'){input='help'}if(isUplinkCode(input)){sessionStorage.setItem('uplink',true);input='uplink '+input}handleMusicCommands(input);if(handleUserPrompts(input)){return}const parts=input.split(' ');const command=parts[0].toLowerCase();const args=parts.slice(1).join(' ');handleCommands(command,args)}function handleMusicCommands(input){if(input==='music start'){console.log('music start');document.getElementById('play-button').click();$('#command-input').val('');return true}if(input==='music stop'){console.log('music stop');if(audio&&!audio.paused){document.getElementById('play-button').click()}$('#command-input').val('');return true}if(input==='music next'){console.log('music next');if(audio){playNextSong()}else{console.log('Use "music start" first.')}$('#command-input').val('');return true}return false}function handleUserPrompts(input){if(isUsernamePrompt){handleUsernamePrompt(input);return true}if(isPasswordPrompt){handlePasswordPrompt();return true}return false}function handleUsernamePrompt(input){if(input){if(currentCommand==='register'){usernameForNewUser=input;loadText("ENTER PASSWORD:");isUsernamePrompt=false;isPasswordPrompt=true;$('#command-input').attr('type','password')}else if(currentCommand==='login'||currentCommand==='logon'){usernameForLogon=input;loadText("ENTER PASSWORD:");isUsernamePrompt=false;isPasswordPrompt=true;$('#command-input').attr('type','password')}}else{loadText("ERROR: WRONG USERNAME")}}function handleCommands(command,args){if(['register','logon','login'].includes(command)&&!sessionStorage.getItem('uplink')){loadText("ERROR: UPLINK REQUIRED");return}if(['logon','login','register'].includes(command)&&sessionStorage.getItem('auth')&&!sessionStorage.getItem('host')){loadText("ERROR: LOGOUT REQUIRED");return}switch(command){case'term':setTermMode(args);break;case'reset':clearTerminal();sendCommand(command,args);break;case'clear':case'cls':clearTerminal();break;case'uplink':sessionStorage.setItem('uplink',true);sendCommand(command,args);break;case'register':handleNewUserCommand(args);break;case'logon':case'login':handleLogonCommand(command,args);break;case'logout':case'close':case'logoff':case'quit':case'dc':case'restart':case'exit':case'reboot':case'halt':case'halt restart':handleExitCommands(command,args);break;case'color':setTheme(args);break;default:sendCommand(command,args);break}}function handleNewUserCommand(args){if(args){handleNewUser(args)}else{promptForUsername('register')}}function handleLogonCommand(command,args){if(args){promptForPassword(command,args)}else{promptForUsername(command)}}function handleExitCommands(command,args){sendCommand(command,args).then(response=>{if(!response.includes("ERROR")){handleSuccessfulExit(command)}}).catch(err=>{console.error("Command failed",err)})}function promptForUsername(command){loadText("ENTER USERNAME:");isUsernamePrompt=true;currentCommand=command;$('#command-input').attr('type','text')}function promptForPassword(command,username){usernameForLogon=username;loadText("ENTER PASSWORD:");isUsernamePrompt=false;isPasswordPrompt=true;currentCommand=command;$('#command-input').attr('type','password')}function handleSuccessfulExit(command){setTimeout(()=>{if(sessionStorage.getItem('host')){sessionStorage.removeItem('host')}if(['boot'].includes(command)){localStorage.removeItem('boot')}redirectTo('',false)},1000)}function sendCommand(command,data,queryString=''){const query=window.location.search;const route=command.split(" ")[0];return new Promise((resolve,reject)=>{$.ajax({type:'GET',url:route.toLowerCase()+queryString,data:{data:data,query:query},success:function(response){loadSavedTheme();$('#connection').load('connection');if(isPasswordPrompt){handlePasswordPromptResponse(response)}else{loadText(response);handleResponse(response)}resolve(response)},error:function(err){reject(err)}})})}function appendCommand(command){const commandElement=$('<div>').addClass('command-prompt').html(command);$('#terminal').append(commandElement);scrollToBottom()}function autoHelp(){fetch('api?key=system&get=auto').then(response=>response.json()).then(data=>{if(Array.isArray(data)){commands=data.filter(item=>typeof item==='string')}else{console.error('ERROR',data)}}).catch(error=>console.error('ERROR',error))}function autocomplete(){const inputField=$('#command-input');const currentText=inputField.val();const lastWordMatch=currentText.match(/(^|\s)(\S*)$/);if(!lastWordMatch)return;const prefix=lastWordMatch[2];const matches=commands.filter(cmd=>typeof cmd==='string'&&cmd.startsWith(prefix));if(matches.length===1){inputField.val(currentText.slice(0,-prefix.length)+matches[0])}else if(matches.length>1){const commonPrefix=findCommonPrefix(matches);if(commonPrefix.length>prefix.length){inputField.val(currentText.slice(0,-prefix.length)+commonPrefix)}else{loadText(`${matches.join(' ')}`)}}else{loadText('')}}function handleLogon(username){if(!sessionStorage.getItem('uplink')){loadText("ERROR: UPLINK REQUIRED");return}if(!usernameForLogon&&!username){loadText("USERNAME:");isUsernamePrompt=true;$('#command-input').attr('type','text');return}if(isPasswordPrompt)return;isPasswordPrompt=true;usernameForLogon=username;loadText("PASSWORD:");$('#command-input').attr('type','password')}function handleNewUser(username){if(!sessionStorage.getItem('uplink')){loadText("ERROR: UPLINK REQUIRED.");return}if(!username){loadText("ERROR: USERNAME REQUIRED.");return}else{usernameForNewUser=username;currentCommand='register'}isPasswordPrompt=true;loadText("PASSWORD:");$('#command-input').attr('type','password')}function handlePasswordPrompt(){let password=$('#command-input').val();if(!password)password="";userPassword=password;if(currentCommand==='logon'||currentCommand==='login'){sendCommand(currentCommand,usernameForLogon+' '+userPassword);usernameForLogon=''}else if(currentCommand==='register'){sendCommand('register',usernameForNewUser+' '+userPassword);usernameForNewUser=''}isPasswordPrompt=false;$('#command-input').attr('type','text').val('')}function handlePasswordPromptResponse(response){if(usernameForLogon){sendCommand('logon',usernameForLogon+' '+(userPassword||""))}else if(usernameForNewUser){sendCommand('register',usernameForNewUser+' '+(userPassword||""))}if(response.startsWith("ERROR: ACCESS DENIED")||response.startsWith("WARNING")){loadText(response);isPasswordPrompt=false;$('#command-input').attr('type','text')}else if(response.startsWith("CONNECTING...")){loadText(response);setTimeout(function(){sessionStorage.setItem('auth',true);clearTerminal();sendCommand('main','')},2500)}$('#command-input').val('')}function loadText(text){let delay=5+Math.random()*10;let currentIndex=0;let lineCharCount=0;const preContainer=$('<pre>');$('#terminal').append(preContainer);function displayNextLetter(){if(currentIndex<text.length){const char=text[currentIndex];if(lineCharCount>=100&&char!=='\n'){const lastChar=preContainer.text().slice(-1);if(lastChar!==' '&&lastChar!=='\n'){const textSoFar=preContainer.text();const lastSpaceIndex=textSoFar.lastIndexOf(' ');if(lastSpaceIndex>0){preContainer.text(textSoFar.slice(0,lastSpaceIndex)+'\n'+textSoFar.slice(lastSpaceIndex+1));lineCharCount=textSoFar.slice(lastSpaceIndex+1).length}else{preContainer.append('\n');lineCharCount=0}}else{preContainer.append('\n');lineCharCount=0}}preContainer.append(char);currentIndex++;if(char==='\n'){lineCharCount=0}else{lineCharCount++}scrollToBottom();setTimeout(displayNextLetter,delay)}else{$('#command-input').focus()}}displayNextLetter()}function scrollToBottom(){const wrapper=document.getElementById('terminal-wrapper');if(wrapper){wrapper.scrollTo({top:wrapper.scrollHeight,behavior:'smooth'})}}function clearTerminal(){$('#terminal').empty()}function loadSavedTheme(){const savedTheme=localStorage.getItem('theme');if(savedTheme){setTheme(savedTheme)}}function setTheme(color){const colors={green:"#2dfd8b",white:"#EAF7F9",yellow:"#ffb642",blue:"#0CD7CF",};const defaultColor="green";const themeColor=colors[color]||colors[defaultColor];$('#theme-style').remove();const styleTag=`<style id="theme-style">*{color:${themeColor}!important}</style>`;$('head').append(styleTag);localStorage.setItem('theme',color)}function setTermMode(mode){const terms=['DEC-VT100','IBM-3270'];if(terms.includes(mode)){$("#page").attr('class',mode);localStorage.setItem('term',mode);sendCommand('term',mode)}else{loadText('UNKNOWN TERMINAL TYPE')}}function loadSavedTermMode(){const savedTerm=localStorage.getItem('term');if(savedTerm){setTermMode(savedTerm)}}function initializeAudio(){if(!audio){audio=new Audio(playlist[currentSongIndex]);audio.loop=false;audio.addEventListener('ended',handleAudioEnded);console.log('Audio element initialized.')}}function playNextSong(){if(playlist.length===0){console.log('Playlist is empty.');return}currentSongIndex=(currentSongIndex+1)%playlist.length;audio.src=playlist[currentSongIndex];audio.play().then(()=>{console.log(`Playing next song:${playlist[currentSongIndex]}`);document.getElementById('play-button').textContent='MUSIC STOP'}).catch(error=>{console.error('Playback failed:',error);alert('Audio playback failed. Please try again or interact with the page.')})}function handleAudioEnded(){playNextSong()}function toggleMusic(){initializeAudio();if(audio.paused){audio.play().then(()=>{console.log('Audio started playing.');document.getElementById('play-button').textContent='MUSIC STOP'}).catch(error=>{console.error('Playback failed:',error);alert('Audio playback failed. Please try again or interact with the page.')})}else{audio.pause();console.log('Audio paused.');document.getElementById('play-button').textContent='MUSIC PLAY'}}